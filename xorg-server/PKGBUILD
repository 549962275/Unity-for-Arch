# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
# Original Maintainer: Jan de Groot <jgc@archlinux.org>

# This package is modified from the Arch Linux xorg-server package.
# Changes:
#  - Only contains the xorg-server and xorg-server-devel packages
#  - Adds 500_pointer_barrier_thresholds.diff patch from Ubuntu
#    - Manually refreshed for Xorg Server 1.12.0
#    - list                -> xorg_list
#    - list_add            -> xorg_list_add
#    - list_del            -> xorg_list_del
#    - list_for_each_entry -> xorg_list_for_each_entry
#    - swaps(param1, param2) -> swaps(param1)
#    - swapl(param1, param2) -> swapl(param1)

pkgbase=xorg-server
pkgname=('xorg-server' 'xorg-server-devel')
pkgver=1.12.0
pkgrel=100
arch=('i686' 'x86_64')
license=('custom')
url="http://xorg.freedesktop.org"
makedepends=('pixman' 'libx11' 'mesa' 'libgl' 'xf86driproto' 'xcmiscproto' 'xtrans' 'bigreqsproto' 'randrproto' 'inputproto' 'fontsproto' 'videoproto' 'compositeproto' 'recordproto' 'scrnsaverproto' 'resourceproto' 'xineramaproto' 'libxkbfile' 'libxfont' 'renderproto' 'libpciaccess' 'libxv' 'xf86dgaproto' 'libxmu' 'libxrender' 'libxi' 'dmxproto' 'libxaw' 'libdmx' 'libxtst' 'libxres' 'xorg-xkbcomp' 'xorg-util-macros' 'xorg-font-util' 'glproto' 'dri2proto' 'udev' 'libgcrypt')
options=('!libtool')
source=("${url}/releases/individual/xserver/${pkgname}-${pkgver}.tar.bz2"
        'autoconfig-nvidia.patch'
        'autoconfig-sis.patch'
        '10-quirks.conf'
        '500_pointer_barrier_thresholds_refreshed_for_1.12.0.diff')
sha512sums=('37dbcc2b418beaf70a74cf10b2f7cde1d9f874d6014cbede5a3b956aff656337d0814cab44ec3c40a869d6a9fc60e17066b88da909a795cf80912da37b212aec'
            'f589f51861ec7a35b707fc973d4df574ebe505b5cea7dde8dcc638be4b85d888e19db684e85d095eb776d9a7c167394e6e7fe7889c5869a0904c777aa4123926'
            '39ab1cd9865e96f3755baff1127db2cd4dc76f0b351a8cca19b4d45866a7c2a95613bc3fc7ec07de661655eca42c43ce680facf4146392ceaff9371e71ae4013'
            '9a1a5568be751435daea720cfc4bad209d62545cc10ea2f49113c41669c8130809a680492256ef331757fe8539d2e0e5e9e67a36f7c48c8d92d9b3e957d28fa2'
            'a32732db51ae192555399fb3917fbba5910ad2518ac71097c460788c2f1a08d0e9b4e046ba436df31a15545a96bccd3e51d54bcc02d2711ff6ca0bb57ee700e2')

build() {
  cd "${srcdir}/${pkgbase}-${pkgver}"

  # Use nouveau/nv/nvidia drivers for nvidia devices
  patch -Np1 -i "${srcdir}/autoconfig-nvidia.patch"

  # Use unofficial imedia SiS driver for supported SiS devices
  patch -Np0 -i "${srcdir}/autoconfig-sis.patch"

  # Patch from Ubuntu for XFixes protocol version 6
  # (needed for revealing the launcher in Unity)
  patch -Np1 -i "${srcdir}/500_pointer_barrier_thresholds_refreshed_for_1.12.0.diff"

  CFLAGS="${CFLAGS} -Wno-shadow"

  autoreconf -vfi

  ./configure \
      --prefix=/usr \
      --enable-ipv6 \
      --enable-dri \
      --enable-dmx \
      --enable-xvfb \
      --enable-xnest \
      --enable-composite \
      --enable-xcsecurity \
      --enable-xorg \
      --enable-xephyr \
      --enable-glx-tls \
      --enable-kdrive \
      --enable-kdrive-evdev \
      --enable-kdrive-kbd \
      --enable-kdrive-mouse \
      --enable-install-setuid \
      --enable-config-udev \
      --disable-config-dbus \
      --enable-record \
      --disable-xfbdev \
      --disable-xfake \
      --disable-static \
      --sysconfdir=/etc/X11 \
      --localstatedir=/var \
      --with-xkb-path=/usr/share/X11/xkb \
      --with-xkb-output=/var/lib/xkb \
      --with-fontrootdir=/usr/share/fonts

  make ${MAKEFLAGS}

  # Disable subdirs for make install rule to make splitting easier
  sed -e 's/^DMX_SUBDIRS =.*/DMX_SUBDIRS =/' \
      -e 's/^XVFB_SUBDIRS =.*/XVFB_SUBDIRS =/' \
      -e 's/^XNEST_SUBDIRS =.*/XNEST_SUBDIRS = /' \
      -e 's/^KDRIVE_SUBDIRS =.*/KDRIVE_SUBDIRS =/' \
      -i hw/Makefile
}

package_xorg-server() {
  pkgdesc="Xorg X server"
  depends=('libdrm' 'pixman' 'libgcrypt' 'xorg-server-common' 'xf86-input-evdev')
  backup=('etc/X11/xorg.conf.d/10-evdev.conf' 'etc/X11/xorg.conf.d/10-quirks.conf')
  provides=('x-server')
  groups=('xorg')
  conflicts=('nvidia-utils<=290.10')

  cd "${srcdir}/${pkgbase}-${pkgver}"
  make DESTDIR="${pkgdir}" install

  install -dm755 "${pkgdir}/etc/X11"
  mv "${pkgdir}/usr/share/X11/xorg.conf.d" "${pkgdir}/etc/X11/"
  install -m644 "${srcdir}/10-quirks.conf" "${pkgdir}/etc/X11/xorg.conf.d/"

  rmdir -v "${pkgdir}/usr/share/X11"

  # Needed for non-mesa drivers, libgl will restore it
  mv -v "${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so" \
        "${pkgdir}/usr/lib/xorg/modules/extensions/libglx.xorg"

  rm -rvf "${pkgdir}/var"

  rm -vf "${pkgdir}/usr/share/man/man1/Xserver.1"
  rm -vf "${pkgdir}/usr/lib/xorg/protocol.txt"

  install -dm755 "${pkgdir}/usr/share/licenses/xorg-server"
  ln -svf ../xorg-server-common/COPYING "${pkgdir}/usr/share/licenses/xorg-server/COPYING"

  rm -rvf "${pkgdir}/usr/lib/pkgconfig"
  rm -rvf "${pkgdir}/usr/include"
  rm -rvf "${pkgdir}/usr/share/aclocal"
}

package_xorg-server-devel() {
  arch=('any')
  pkgdesc="Development files for the X.Org X server"
  depends=('xproto' 'randrproto' 'renderproto' 'xextproto' 'inputproto' 'kbproto' 'fontsproto' 'videoproto' 'dri2proto' 'xineramaproto' 'xorg-util-macros' 'pixman' 'libpciaccess')

  cd "${srcdir}/${pkgbase}-${pkgver}"
  make DESTDIR="${pkgdir}" install

  rm -rvf "${pkgdir}/usr/bin"
  rm -rvf "${pkgdir}/usr/share/man"
  rm -rvf "${pkgdir}/usr/share/doc"
  rm -rvf "${pkgdir}/usr/share/X11"
  rm -rvf "${pkgdir}/usr/lib/xorg"
  rm -rvf "${pkgdir}/var"

  install -dm755 "${pkgdir}/usr/share/licenses/xorg-server-devel"
  ln -svf ../xorg-server-common/COPYING "${pkgdir}/usr/share/licenses/xorg-server-devel/COPYING"
}
