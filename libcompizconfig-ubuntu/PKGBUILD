# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

pkgname=libcompizconfig-ubuntu

_ubuntu_rel=0ubuntu4
_ubuntu_ver='~bzr428'
_actual_ver=0.9.7.0
_WTF_ver=0.9.5.94

pkgver=${_actual_ver}.bzr428.${_ubuntu_rel}

pkgrel=100
pkgdesc="Compiz configuration system library - Ubuntu version"
arch=('i686' 'x86_64')
url="http://compiz.org"
license=('GPL')
depends=('compiz-core-ubuntu' 'libxml2' 'protobuf')
makedepends=('intltool' 'pkgconfig' 'cmake')
provides=('libcompizconfig')
conflicts=('libcompizconfig')
groups=('unity')
install=${pkgname%-*}.install
source=("https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname%-*}_${_actual_ver}${_ubuntu_ver}.orig.tar.bz2"
        "https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname%-*}_${_actual_ver}${_ubuntu_ver}-${_ubuntu_rel}.debian.tar.gz")
sha512sums=('13612ebcdd3016c5111a664487dd76412ef39f59fe986c0805a96d58696780d200e70dfd09e2d93a20e4c35aeb5cd2959a79c6b544d465c9232a60889b692e19'
            'f9e97b55d8b028780a25578052919cbfbf3ce0b4b723ee8142c7fce92467737ddb82d3ad621c313457e44e50243cb43e023a7370ba71445728bbb2e2b62da6c3')

build() {
  cd "${srcdir}/${pkgname%-*}-${_WTF_ver}"

  # Apply Ubuntu patches
  for i in $(cat "${srcdir}/debian/patches/series" | grep -v '#'); do
    patch -Np1 -i "${srcdir}/debian/patches/${i}"
  done

  [[ -d build ]] || mkdir build
  cd build
  cmake .. \
    -DCMAKE_BUILD_WITH_RPATH=FALSE \
    -DCOMPIZ_PACKAGING_ENABLED=TRUE \
    -DCOMPIZ_PLUGIN_INSTALL_TYPE=package \
    -DUSE_GSETTINGS=OFF \
    -DCOMPIZ_DISABLE_GS_SCHEMAS_INSTALL=ON \
    -DCMAKE_BUILD_TYPE="Release" \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCOMPIZ_DESTDIR="${pkgdir}"

  make ${MAKEFLAGS}
}

package() {
  cd "${srcdir}/${pkgname%-*}-${_WTF_ver}"
  cd "build"
  make install
  make findcompizconfig_install

  install -dm755 "${pkgdir}/usr/share/compizconfig"
  install -dm755 "${pkgdir}/etc/compizconfig"
  install -m644 "${srcdir}/debian/normal.profile" \
    "${pkgdir}/usr/share/compizconfig/"
  install -m644 "${srcdir}/debian/extra.profile" \
    "${pkgdir}/usr/share/compizconfig/"
  install -m644 "../config/config" "${pkgdir}/etc/compizconfig/"
}
