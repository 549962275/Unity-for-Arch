# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
# Contributor: Marius Dransfeld <marius.dransfeld@googlemail.com>
# Contributor: thn81 <root@scrat>

pkgname=unity-2d
_ubuntu_rel=0ubuntu1
pkgver=5.8.0.${_ubuntu_rel}
pkgrel=100
pkgdesc="Unity interface for non-accelerated graphics cards"
arch=('i686' 'x86_64')
url="http://launchpad.net/unity-2d"
license=('GPL')
depends=('qt-ubuntu>=4.8.0.1ubuntu11-101' 'libdbusmenu-qt' 'libindicator' 'libqtbamf' 'libqtdee' 'libqtgconf' 'metacity-ubuntu' 'unity-lens-files' 'unity-lens-applications' 'unity-asset-pool' 'nux' 'unity-core' 'nautilus-ubuntu' 'gnome-session-ubuntu' 'gnome-themes-standard' 'gconf-ubuntu' 'xorg-server>=1.12.0-100' 'dconf-qt')
makedepends=('cmake')
conflicts=('unity2d-bzr')
replaces=('unity2d-bzr')
groups=('unity')
optdepends=('appmenu-gtk: Export GTK menus over DBus'
            'appmenu-qt: appmenu support for Qt')
options=('!emptydirs')
install=${pkgname}.install
source=("https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname}_${pkgver%.*}.orig.tar.gz"
        "https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname}_${pkgver%.*}-${_ubuntu_rel}.diff.gz"
        "launchpad-export-2d.tar.gz::http://ubuntuone.com/0SVDsqeV12zqz4FfcIVwMZ" # Snapshot of translations from Launchpad as of 2012-03-03
        'fix_QMouseEvent_error.patch'
        'workaround_xfixes_issue.patch')
sha512sums=('d81e0be2acfda0b34dcb4560a04bbe18edeb4e501ae68345a5cd693a2691ab9ecb10e929b9f1574b901bf2fea69930dfe9373fe5932374e1bfe8d62bfda75e96'
            '95e9d6344dbc60b901d8b493d9ac06d1f12958742b4dd7f436f2c2278550e3470f78542071a4321d25a024cae2c4e89a656b245b5e3bc4550efd9778ddf10243'
            '8cfd6d7f852b7ccf759f48b788a8239e3df732a10d81ede29fc6caaf95bc106f0ba6105c192b619a08945d6286f3e4ee59b5c690837f7a74a5fe7a705c70dcbc'
            'c7a1c7d94dd91be89de16fb1b88cd56cff74f1a9e12d70cca74ce6905ddfb3b8755d001511cbbc1b8c41f859905d3c2a7be4aff936d2ae8928ae156bf9247237'
            '093bf6d59e56b33d1787c0f99bd1ec802218abbc5f0277f0fa48fb003285af7047648b0e734b0bbbe5d32691b0a79629362c5d90648a406e35a560c5d3557a28')

# https://bugs.launchpad.net/unity-2d/+bug/809205
export NO_PNG_PKG_MANGLE=1

build() {
  cd "${srcdir}/${pkgname}-${pkgver%.*}"

  # Apply Ubuntu patches
  patch -Np1 -i "${srcdir}/${pkgname}_${pkgver%.*}-${_ubuntu_rel}.diff"
  for i in $(cat debian/patches/series | grep -v '#'); do
    patch -Np1 -i "debian/patches/${i}"
  done

  # Install translations from Launchpad
  pushd po
  rm -f LINGUAS && touch LINGUAS # Recreate LINGUAS (list of languages) file
  for i in "${srcdir}"/po/*.po; do
    _NEWFILE=${i##*/} # Strip path
    _NEWFILE=${_NEWFILE##*-} # Strip 'unity-2d-'
    cp "${i}" "${_NEWFILE}" # Copy new translation
    echo "${_NEWFILE%.*}" >> LINGUAS # Add translation
  done
  cp "${srcdir}/po/unity-2d.pot" unity-2d.pot
  popd

  # Fix Qt4 imports directory
  sed -i 's|qt4/imports|qt/imports|' libunity-2d-private/Unity2d/CMakeLists.txt

  # QMouseEvent wasn't included in the source file
  patch -Np1 -i "${srcdir}/fix_QMouseEvent_error.patch"

  # Workaround issue with xfixes
  patch -Np1 -i "${srcdir}/workaround_xfixes_issue.patch"

  mkdir build
  cd build
  cmake .. \
    `#-DCMAKE_BUILD_TYPE=Release` \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    -DCMAKE_INSTALL_LIBDIR=lib
  make ${MAKEFLAGS}
}

package() { 
  cd "${srcdir}/${pkgname}-${pkgver%.*}"
  pushd build
  make DESTDIR="${pkgdir}/" install
  popd

  # Install GConf stuff
  install -dm755 "${pkgdir}/usr/share/gconf/"
  install -dm755 "${pkgdir}/usr/share/gconf/ubuntu-2d/mandatory/"
  install -dm755 "${pkgdir}/usr/share/gconf/ubuntu-2d/default/"
  install -m644 debian/gconf/ubuntu-2d.default.path "${pkgdir}/usr/share/gconf/"
  install -m644 debian/gconf/ubuntu-2d.mandatory.path "${pkgdir}/usr/share/gconf/"
  install -m644 debian/20_ubuntu-2d-gconf-mandatory "${pkgdir}/usr/share/gconf/ubuntu-2d/mandatory/"
  install -m644 debian/20_ubuntu-2d-gconf-default "${pkgdir}/usr/share/gconf/ubuntu-2d/default/"

  # Install manuals
  install -dm755 "${pkgdir}/usr/share/man/man1/"
  for i in debian/manpages/*; do
    install -m644 "${i}" "${pkgdir}/usr/share/man/man1/"
  done
}
