# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

_UBUNTU=true # Using Ubuntu patches?

pkgname=unity
pkgver=6.0.0
_actual_ver="${pkgver}"

if [ "${_UBUNTU}" == true ]; then
  _ubuntu_rel=0ubuntu4
  pkgver="${pkgver}.${_ubuntu_rel}"
fi

pkgrel=100
pkgdesc="A desktop experience designed for efficiency of space and interaction"
arch=('i686' 'x86_64')
url="https://launchpad.net/unity"
license=('GPL')
depends=('bamf' 'boost' 'compiz-ubuntu' 'clutter-gtk' 'gconf-ubuntu' 'gjs' 'gnome-desktop' 'gnome-session-ubuntu' 'libgnomeui' 'libindicator' 'libnotify' 'libunique' 'libunity' 'libunity-misc' 'nux' 'python2-gconf' 'unity-asset-pool' 'vala' 'xorg-server>=1.12.0-100' 'libindicator3' 'libxfixes-ubuntu')
makedepends=('cmake' 'intltool' 'pkg-config' 'doxygen' 'gmock' 'gtest' 'python2-distribute')
groups=('unity')
provides=("unity-core=${_actual_ver}")
conflicts=('unity-core')

# Do not use ccache or distcc
BUILDENV=(fakeroot !distcc color !ccache check !sign)

install=unity.install
source=("https://launchpad.net/unity/6.0/6.0/+download/unity-${_actual_ver}.tar.bz2"
        "https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname}_${_actual_ver}-${_ubuntu_rel}.diff.gz"
        # No longer using ompldr - too much downtime
        # kiwi6 is terrible too
        "launchpad_export.tar.gz::http://ubuntuone.com/4ShN81tFVBIHi3UrapNRtw" # Snapshot of translations from Launchpad as of 2012-04-26
        '0001_fix_gtest_directory.patch'
        '0003_Ignore_deprecated_schema_path.patch'
        '0004_geis.patch'
        '0005_link_dbus-glib.patch'
        'launcher_bfb.png'
        'archlinux_branding.patch'
        'unity-migrate-dconf-path.desktop')
sha512sums=('2e49c9c273db905aad4ea01b5bd71f687ba0346134e625ad650bae748b7a7116c99a2484ca2c0ad817aec40c994325943813697f4ff67ce4cfee7ae70449f80e'
            '2595d78d4a18e77df16b0b80645ed6c0f07590af315edd33f2b790d0897423d94b21f63a9eaf37988aa2806f11a0ac05b7124f27505e2f5a7ae8a70598380504'
            '20dad43d03d4e7c8c4f16c759b55045c105390ea4fa70311f8c89b1b2e2db83538fe8307bbdc8c5e482a805d892bc8c6175084c5ca3368166a244896e1bf7796'
            '17c7a3b6ba44d4edd50b9fca8b730c0ecfbe70f95ffa386c92992e057dedaed48b88d4b6c593c370514e49b81c003cfc5aad4e8ada9c4332824d862fe2fd6323'
            '0c71d841876a9d9382f8b36bc97918f039d9ab69823bb6b1407d0ca432f215ccef5494eae351481a92274e6063c0d19a1f41d44677f430c7a3cc12cba79a3398'
            'cfa0cc004d62c657034731c905e9d306a5355c51ed3beafb06c6b4148d5f6adac0fa10a97ab88b31b802eba9ea6c15a085fc55901d555d35f6ed65cd06603ac0'
            '68e4bd38170130e43a61593e31db3246377734a928675465dbeca05215cff73fe65c8fc46c82b3c7f7e86a06bf468bbdc9103cb1dab21ce9b2eb87689af13db6'
            '9f5469c0300d0c33e26db670771803efd3d821e82689fbb1391a31b8fd0e280a12ea010fe6f32a702a5d1797918d416c8adabfccf6049e43b496ebb6dbe2c054'
            '81461a337a0768035774e2d6a27f1468f9ce3ca62385b2f24dcafeddbff52e1c42bef3a8f8c338b34608a47535a9d037056bd318a6f46b8bf04a67ae55f125bf'
            '8eb535adc7aefd95c0ccfdd35525b4be764c4377ae5fc6002ad6ef6fd84b733c9054f8228083ce50eac1f970fdc1ef987ad1eb47813e7621b481ec3f490a9df7')


# GPG public key:
#   gpg --keyserver keyserver.ubuntu.com --recv-keys 90EFF32C
case ${CARCH} in
i686)
  # GPG signature: http://ompldr.org/vZXFsZA/gcc46-4.6.3-1-i686.pkg.tar.xz.asc
  source+=('http://ompldr.org/vZXFsYw/gcc46-4.6.3-1-i686.pkg.tar.xz')
  sha512sums+=('a715da56bce0cf39b28cd55d6f7d6be07324400fbb4b550e289ebf301820f2f006f68149129fd6d2842268e698d053b4d40799d2f066a47a32913db2a065de57')
  ;;
x86_64)
  # GPG signature: http://ompldr.org/vZXFsZg/gcc46-4.6.3-1-x86_64.pkg.tar.xz.asc
  source+=('http://ompldr.org/vZXFsaA/gcc46-4.6.3-1-x86_64.pkg.tar.xz')
  sha512sums+=('a707fd950273140355bad5af8ca5da7c4b6c8f69ccaa6945d427f8fc1104ef308bdfbd32b46e65a62b06576ff7cecf22182579888767d6cb33d4133f2f37c4b0')
  ;;
esac

build() {
  cd "${srcdir}/${pkgname}-${_actual_ver}"

  # Arch Linux branding: "Ubuntu Desktop" -> "Arch Linux Desktop"
  # (thanks to qiuwei!)
  patch -Np1 -i "${srcdir}/archlinux_branding.patch"

  # Apply Ubuntu patches
  patch -Np1 -i "${srcdir}/${pkgname}_${_actual_ver}-${_ubuntu_rel}.diff"

  for i in $(cat debian/patches/series | grep -v '#'); do
    patch -Np1 -i "debian/patches/${i}"
  done

  # Fix the gtest search in CMake
  patch -Np1 -i "${srcdir}/0001_fix_gtest_directory.patch"

  # Ignore error about deprecated paths in GSettings schemas
  patch -Np1 -i "${srcdir}/0003_Ignore_deprecated_schema_path.patch"

  # utouch-geis was renamed to geis upstream
  patch -Np1 -i "${srcdir}/0004_geis.patch"

  # Link against dbus-glib to avoid:
  #  /usr/bin/ld: CMakeFiles/panel.dir/StandalonePanel.cpp.o: undefined reference to symbol 'dbus_g_thread_init'
  patch -Np1 -i "${srcdir}/0005_link_dbus-glib.patch"

  # Cannot find gmodule
  CXXFLAGS="${CXXFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"
  CFLAGS="${CFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"

  # Fix pkgconfig
  #sed -i -e 's/\${libdir}/@LIBDIR@/g' -e 's/\${includedir}/@INCLUDEDIR@/g' UnityCore/unity-core.pc.cmake

  # Install translations from Launchpad
  pushd po
  rm LINGUAS && touch LINGUAS # Recreate LINGUAS (list of languages) file
  for i in "${srcdir}"/po/*.po; do
    _NEWFILE=${i##*/} # Strip path
    _NEWFILE=${_NEWFILE#*-} # Strip 'unity-'
    cp "${i}" "${_NEWFILE}" # Copy new translation
    echo "${_NEWFILE%.*}" >> LINGUAS # Add translation
  done
  cp "${srcdir}/po/unity.pot" unity.pot
  popd

  # Disable '-Werror'
  #sed -i 's/[ ]*-Werror[ ]*//g' CMakeLists.txt services/CMakeLists.txt

  # Build with gcc 4.6.3
  PATH="${srcdir}/usr/bin:/usr/bin:/bin:/usr/sbin"

  [[ -d build ]] && rm -rvf build/
  mkdir build/ && cd build/

  case ${CARCH} in
    x86_64)
      C_COMPILER="${srcdir}/usr/bin/x86_64-unknown-linux-gnu-gcc-4.6"
      CXX_COMPILER="${srcdir}/usr/bin/x86_64-unknown-linux-gnu-g++-4.6"
      ;;
    i686)
      C_COMPILER="${srcdir}/usr/bin/i686-pc-linux-gnu-gcc-4.6"
      CXX_COMPILER="${srcdir}/usr/bin/i686-pc-linux-gnu-g++-4.6"
      ;;
  esac

  cmake \
    -DCOMPIZ_BUILD_WITH_RPATH=FALSE \
    -DCOMPIZ_PACKAGING_ENABLED=TRUE \
    -DCOMPIZ_PLUGIN_INSTALL_TYPE=package \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_C_COMPILER="${C_COMPILER}" \
    -DCMAKE_CXX_COMPILER="${CXX_COMPILER}" \
    ..

  make ${MAKEFLAGS}

  # Build autopilot tests
  pushd ../tests/autopilot/
  python2 setup.py build
  popd
}

package() {
  cd "${srcdir}/${pkgname}-${_actual_ver}/build"
  make DESTDIR="${pkgdir}/" install

  # Install autopilot and autopilot tests
  pushd ../tests/autopilot/
  python2 setup.py install --root "${pkgdir}" --skip-build --optimize=1
  popd

  # Install dconf path migration stuff
  install -dm755 "${pkgdir}/etc/xdg/autostart/"
  install -m644 "${srcdir}/unity-migrate-dconf-path.desktop" \
    "${pkgdir}/etc/xdg/autostart/"
  install -m755 ../tools/migration-scripts/01_unity_change_dconf_path \
    "${pkgdir}/usr/lib/unity/"

  # Install profile upgrade helper
  install -dm755 "${pkgdir}/etc/compizconfig/upgrades/"
  install -m644 ../debian/profile_upgrade/* \
    "${pkgdir}/etc/compizconfig/upgrades/"

  # Taken from Ubuntu source package's debian/rules file
  find "${pkgdir}/usr/lib" -name \*.*a -exec rm {} \;
  rm -vf "${pkgdir}/usr/share/compiz/networkarearegion.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libnetworkarearegion.so"
  rm -vf "${pkgdir}/usr/share/compiz/unitydialog.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libunitydialog.so"

  # Fix Python 2 scripts
  sed -i 's|^\(#!.*python$\)|\12|g' \
    "${pkgdir}/usr/bin/unity" \
    "${pkgdir}/usr/lib/unity/makebootchart.py"

  # Arch Linux logo
  install -m644 "${srcdir}/launcher_bfb.png" \
    "${pkgdir}/usr/share/unity/6/launcher_bfb.png"
}

# vim:set ts=2 sw=2 et:
