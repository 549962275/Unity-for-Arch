# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

_UBUNTU=true # Using Ubuntu patches?

pkgname=unity
pkgver=5.8.0

if [ "${_UBUNTU}" == true ]; then
  _ubuntu_rel=0ubuntu1
  pkgver="${pkgver}.${_ubuntu_rel}"
  _actual_ver="${pkgver%.*}"
else
  _actual_ver="${pkgver}"
fi

pkgrel=100
pkgdesc="A desktop experience designed for efficiency of space and interaction"
arch=('i686' 'x86_64')
url="https://launchpad.net/unity/"
license=('GPL')
depends=('bamf' 'boost' 'ccsm-ubuntu' 'clutter-gtk' 'gconf-ubuntu' 'gjs' 'glib2-ubuntu' 'gnome-desktop' 'gnome-session-ubuntu' 'libgnomeui' 'libindicator' 'libnotify' 'libunique' 'libunity' 'libunity-misc' 'nux' 'python2-gconf' 'unity-asset-pool' 'vala' 'xorg-server>=1.12.0-100' 'libindicator3')
makedepends=('cmake' 'intltool' 'pkg-config' 'doxygen' 'gmock' 'gtest')
groups=('unity')
provides=("unity-core=${_actual_ver}")
conflicts=('unity-core')
install=unity.install
source=("http://launchpad.net/unity/${_actual_ver%%.*}.0/${_actual_ver}/+download/${pkgname}-${_actual_ver}.tar.bz2"
        "https://launchpad.net/ubuntu/+archive/primary/+files/${pkgname}_${_actual_ver}-${_ubuntu_rel}.diff.gz"
        # No longer using ompldr - too much downtime
        # kiwi6 is terrible too
        "launchpad_export.tar.gz::http://ubuntuone.com/1uOWRNegG0LvwZKnerHoMk" # Snapshot of translations from Launchpad as of 2012-03-03
        'fix_test-gtest-xless.patch'
        'fix_gtest_directory.patch'
        'launcher_bfb.png')
sha512sums=('715a74319b0dc335d0193f7769a74e85c6a5091e69cf484621680a3384cb0e70fa33860eab6308470d6fcfc476c9c7b66634ee6c4ee7fe41cdbd5bdab94ea1be'
            '911310f059907b8d7cdf89da38f4cfe90b79e656f58b02bee2b9f95d14bb3c1a0681482e9669451f8b98cd585747ba9d181e976b804f4899511f93a966dd15e0'
            'f80df915dfc13502a96a19b5b62c1c1a0bb626d91f4a3559b3c2877ce5356bd69e60f618f026aecc281edf87c6411196a1558763143e610d0f2d18b2892c74b8'
            'dab7371e5c353ea3a95bf37d768c4cd0a530280d1560f043387d037fec5b6a028c155a0c10bfa982fbe5d07ba11c229a69724206cee8f21be9aa249ed213f5a5'
            '5a7396d02e532eaa3fe57a03646274d716c53760967f0d8caeb323e451622a1ccf8f92c71c4b40c5c602016ae62d9d5df314d9015943586149b0432a1515d6fc'
            '9f5469c0300d0c33e26db670771803efd3d821e82689fbb1391a31b8fd0e280a12ea010fe6f32a702a5d1797918d416c8adabfccf6049e43b496ebb6dbe2c054')

build() {
  cd "${srcdir}/${pkgname}-${_actual_ver}"

  # Apply Ubuntu patches
  patch -Np1 -i "${srcdir}/${pkgname}_${_actual_ver}-${_ubuntu_rel}.diff"

  for i in $(cat debian/patches/series | grep -v '#'); do
    patch -Np1 -i "debian/patches/${i}"
  done

  # Disable tests for now; fails to build with:
  # Built target test-gtest-dbus
  # /usr/bin/ld: CMakeFiles/test-gtest-xless.dir/test_grabhandle.cpp.o: undefined reference to symbol 'pthread_setspecific@@GLIBC_2.2.5'
  # /usr/bin/ld: note: 'pthread_setspecific@@GLIBC_2.2.5' is defined in DSO /lib/libpthread.so.0 so try adding it to the linker command line
  # /lib/libpthread.so.0: could not read symbols: Invalid operation
  #sed -i '/tests/d' CMakeLists.txt

  # Fix tests
  patch -Np1 -i "${srcdir}/fix_test-gtest-xless.patch"

  # Fix gtest directory
  patch -Np1 -i "${srcdir}/fix_gtest_directory.patch"

  # Cannot find gmodule
  CXXFLAGS="${CXXFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"
  CFLAGS="${CFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"

  # Fix pkgconfig
  #sed -i -e 's/\${libdir}/@LIBDIR@/g' -e 's/\${includedir}/@INCLUDEDIR@/g' UnityCore/unity-core.pc.cmake

  # Install translations from Launchpad
  pushd po
  rm LINGUAS && touch LINGUAS # Recreate LINGUAS (list of languages) file
  for i in "${srcdir}"/po/*.po; do
    _NEWFILE=${i##*/} # Strip path
    _NEWFILE=${_NEWFILE#*-} # Strip 'unity-'
    cp "${i}" "${_NEWFILE}" # Copy new translation
    echo "${_NEWFILE%.*}" >> LINGUAS # Add translation
  done
  cp "${srcdir}/po/unity.pot" unity.pot
  popd

  # Disable '-Werror'
  sed -i 's/[ ]*-Werror[ ]*//g' CMakeLists.txt services/CMakeLists.txt

  mkdir -p build && cd build

  cmake \
    -DCOMPIZ_BUILD_WITH_RPATH=FALSE \
    -DCOMPIZ_PACKAGING_ENABLED=TRUE \
    -DCOMPIZ_PLUGIN_INSTALL_TYPE=package \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    ..
  make ${MAKEFLAGS}
}

package() {
  cd "${srcdir}/${pkgname}-${_actual_ver}"
  cd 'build'
  make DESTDIR="${pkgdir}/" install

  # Install profile upgrade helper
  install -dm755 "${pkgdir}/etc/compizconfig/upgrades/"
  install -m644 ../debian/profile_upgrade/* \
    "${pkgdir}/etc/compizconfig/upgrades/"

  # Taken from Ubuntu source package's debian/rules file
  find "${pkgdir}/usr/lib" -name \*.*a -exec rm {} \;
  rm -vf "${pkgdir}/usr/share/compiz/networkarearegion.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libnetworkarearegion.so"
  rm -vf "${pkgdir}/usr/share/compiz/unitydialog.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libunitydialog.so"

  # Fix Python 2 scripts
  sed -i 's|^\(#!.*python$\)|\12|g' \
    "${pkgdir}/usr/bin/unity" \
    "${pkgdir}/usr/lib/unity/migrate_favorites.py" \
    "${pkgdir}/usr/lib/unity/makebootchart.py"

  # Arch Linux logo
  install -m644 "${srcdir}/launcher_bfb.png" \
    "${pkgdir}/usr/share/unity/5/launcher_bfb.png"
}
